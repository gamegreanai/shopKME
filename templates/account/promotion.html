{% load static %}

<div class="promotion-section mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="fw-bold text-pink">โปรโมชั่น</h5>
    <div class="promo-nav d-none d-lg-flex">
      <button class="btn btn-outline-pink btn-sm me-2" id="promo-prev">
        <i class="bi bi-chevron-left"></i>
      </button>
      <button class="btn btn-outline-pink btn-sm" id="promo-next">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </div>

  {% comment %} <!--  ส่วนสไลด์แนวนอน --> {% endcomment %}
  <div class="promo-slider-wrapper position-relative overflow-hidden">
    <div class="promo-slider d-flex gap-3">
      {% for p in promotions %}
        {% if p.is_active_now %}
        <div class="promo-card card shadow-sm border-0">
          <div class="ratio ratio-16x9">
            {% if p.cover_image %}
              <img src="{{ p.cover_image.url }}" class="card-img-top" alt="{{ p.title }}">
            {% else %}
              <img src="{% static 'img/promo-placeholder.webp' %}" class="card-img-top" alt="Promotion">
            {% endif %}
          </div>

          <div class="card-body d-flex flex-column">
            <h6 class="card-title fw-bold text-pink">{{ p.title }}</h6>
            {% if p.short_text %}
              <p class="text-muted small clamp-2">{{ p.short_text }}</p>
            {% endif %}
            <div class="mt-auto">
              <button class="btn btn-pink btn-sm w-100"
                      data-bs-toggle="modal"
                      data-bs-target="#promotionDetailModal-{{ p.id }}">
                รายละเอียด
              </button>
            </div>
          </div>
        </div>

        {% include "account/promotion_detail_modal.html" with p=p %}
        {% endif %}
      {% endfor %}
    </div>
  </div>
</div>

{% comment %} <!--  CSS ปลอดภัย --> {% endcomment %}
<style>
  {% comment %} /*  สีหลัก */ {% endcomment %}
  .text-pink { color: #e91e63 !important; }
  .btn-pink {
    background-color: #e91e63;
    color: #fff;
    border-radius: 0.5rem;
  }
  .btn-pink:hover {
    background-color: #fff;
    color: #e91e63;
    border: 1px solid #e91e63;
  }
  .btn-outline-pink {
    border: 1px solid #e91e63;
    color: #e91e63;
  }
  .btn-outline-pink:hover {
    background-color: #e91e63;
    color: #fff;
  }

  {% comment %} /*  โครง slider */ {% endcomment %}
  .promo-slider-wrapper {
    position: relative;
    width: 100%;
  }

  .promo-slider {
    display: flex;
    transition: transform 0.5s ease;
  }

  .promo-card {
    flex: 0 0 calc(33.333% - 1rem);
    border-radius: 1rem;
    background: #fff;
    overflow: hidden;
    min-width: 300px;
    max-width: 320px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .promo-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(233, 30, 99, 0.2);
  }

  .clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  {% comment %} /*  มือถือและแท็บเล็ต */ {% endcomment %}
  @media (max-width: 991px) {
    .promo-slider {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      transform: none !important;
    }

    .promo-card {
      width: 100%;
      min-width: auto;
      max-width: none;
    }

    .promo-nav {
      display: none !important;
    }
  }

  {% comment %} /*  ปรับ spacing ในมือถือ */ {% endcomment %}
  @media (max-width: 576px) {
    .promo-slider {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.8rem;
    }
  }
</style>

{% comment %} <!--  JavaScript ควบคุมการเลื่อน (Desktop เท่านั้น) --> {% endcomment %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const slider = document.querySelector(".promo-slider");
    const cards = document.querySelectorAll(".promo-card");
    const prevBtn = document.getElementById("promo-prev");
    const nextBtn = document.getElementById("promo-next");

    if (!slider || !cards.length) return;

    let currentIndex = 0;
    {% comment %} let cardWidth = cards[0].offsetWidth + 24; // รวมช่องว่าง {% endcomment %}
    const cardsPerView = 3;

    function updateSlider() {
      if (window.innerWidth > 991) {
        slider.style.transform = `translateX(-${currentIndex * cardWidth}px)`;
      } else {
        slider.style.transform = "none";
      }
    }

    nextBtn?.addEventListener("click", () => {
      if (currentIndex < cards.length - cardsPerView) {
        currentIndex++;
        updateSlider();
      }
    });

    prevBtn?.addEventListener("click", () => {
      if (currentIndex > 0) {
        currentIndex--;
        updateSlider();
      }
    });

    window.addEventListener("resize", () => {
      cardWidth = cards[0].offsetWidth + 24;
      updateSlider();
    });
  });
</script>
