{# templates/partials/promotion.html #}
{% load static %}

{# คาดหวังตัวแปร: promotions (QuerySet[Promotion]), optional: show_title, user, subtotal #}
<div class="promo-wrapper">
  {% if show_title %}
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h5 class="mb-0 fw-bold">โปรโมชั่น</h5>
      {% if promotions.has_other_pages %}
        <small class="text-muted">Page {{ promotions.number }} / {{ promotions.paginator.num_pages }}</small>
      {% endif %}
    </div>
  {% endif %}

  {% if promotions %}
    <div class="row g-3">
      {% for p in promotions %}
        {# ควรกรอง active ใน view แล้ว แต่กันพลาดอีกชั้น #}
        {% if p.is_active_now %}
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card promo-card shadow-sm h-100 border-0">
            <div class="ratio ratio-16x9 promo-cover position-relative">
              {% if p.cover_image %}
                <img src="{{ p.cover_image.url }}" class="card-img-top" alt="{{ p.title|default:'Promotion' }}">
              {% else %}
                <img src="{% static 'img/promo-placeholder.webp' %}" class="card-img-top" alt="Promotion">
              {% endif %}
              {% if p.coupon %}
                <span class="badge bg-dark-subtle text-dark position-absolute top-0 end-0 m-2 border rounded-pill">
                  <i class="fa fa-ticket me-1"></i> {{ p.coupon.code }}
                </span>
              {% endif %}
              {% if p.priority|default:0 > 0 %}
                <span class="badge bg-danger position-absolute top-0 start-0 m-2">
                  HOT
                </span>
              {% endif %}
            </div>

            <div class="card-body d-flex flex-column">
              <h6 class="card-title mb-1 text-truncate" title="{{ p.title }}">{{ p.title }}</h6>
              {% if p.short_text %}
                <p class="card-text text-muted small mb-2 clamp-2">{{ p.short_text }}</p>
              {% endif %}

              <div class="d-flex flex-wrap gap-2 mb-2">
                {% if p.min_spend and p.min_spend|floatformat:0 != "0" %}
                  <span class="badge rounded-pill bg-light text-dark border">
                    ยอดขั้นต่ำ {{ p.min_spend }} ฿
                  </span>
                {% endif %}

                {% if p.allowed_levels %}
                  <span class="badge rounded-pill bg-primary-subtle text-primary border">
                    สำหรับ: {{ p.allowed_levels|join:", " }}
                  </span>
                {% else %}
                  {% comment %} <span class="badge rounded-pill bg-success-subtle text-success border">ทุกระดับ</span> {% endcomment %}
                {% endif %}
              </div>

              <div class="text-muted small mb-3">
                <i class="fa fa-clock-o me-1"></i>
                {{ p.starts_at|date:"d M Y" }}{% if p.ends_at %} – {{ p.ends_at|date:"d M Y" }}{% endif %}
              </div>

              <div class="mt-auto d-flex gap-2">
                {# ปุ่มเปิดแกลเลอรี ถ้ามีรูปหลายรูป #}
                {% if p.images.all %}
                  <button class="btn btn-outline-secondary btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#promoGalleryModal-{{ p.id }}">
                    <i class="fa fa-image me-1"></i> ดูรูป
                  </button>
                {% endif %}

                {# ลิงก์ไปหน้าโปรโมชันเต็ม (แก้ชื่อ url ให้ตรงโปรเจ็กต์) #}
                <button class="btn btn-primary btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#promotionDetailModal-{{ p.id }}">
                รายละเอียด
                </button>
              </div>
            </div>
          </div>
        </div>
        {% include "staff/promotion_detail_modal.html" with p=p %}
        {# Modal แกลเลอรีของโปรโมชันนี้ #}
        {% if p.images.all %}
        <div class="modal fade" id="promoGalleryModal-{{ p.id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow">
              <div class="modal-header">
                <h6 class="modal-title">{{ p.title }}</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด"></button>
              </div>
              <div class="modal-body">
                <div id="promoCarousel-{{ p.id }}" class="carousel slide" data-bs-ride="false">
                  <div class="carousel-inner">
                    {% if p.cover_image %}
                      <div class="carousel-item active">
                        <img src="{{ p.cover_image.url }}" class="d-block w-100" alt="{{ p.title }}">
                      </div>
                    {% endif %}
                    {% for img in p.images.all %}
                      <div class="carousel-item {% if not p.cover_image and forloop.first %}active{% endif %}">
                        <img src="{{ img.image.url }}" class="d-block w-100" alt="{{ img.alt_text|default:p.title }}">
                      </div>
                    {% endfor %}
                  </div>
                  <button class="carousel-control-prev" type="button" data-bs-target="#promoCarousel-{{ p.id }}" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">ก่อนหน้า</span>
                  </button>
                  <button class="carousel-control-next" type="button" data-bs-target="#promoCarousel-{{ p.id }}" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">ถัดไป</span>
                  </button>
                </div>
              </div>
              <div class="modal-footer">
                <a class="btn btn-primary" href="{% url 'promotion_detail' slug=p.slug %}">
                  ไปยังหน้าโปรโมชัน
                </a>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        {% endif %}
      {% endfor %}
    </div>

    {# ตัวอย่าง pagination (ถ้า promotions เป็น Page object) #}
    {% if promotions.has_other_pages %}
      <nav class="mt-3">
        <ul class="pagination pagination-sm mb-0">
          {% if promotions.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ promotions.previous_page_number }}">«</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">«</span></li>
          {% endif %}

          {% for num in promotions.paginator.page_range %}
            <li class="page-item {% if promotions.number == num %}active{% endif %}">
              <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
          {% endfor %}

          {% if promotions.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ promotions.next_page_number }}">»</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">»</span></li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
  {% else %}
    <div class="text-center text-muted py-4">
      <i class="fa fa-bullhorn mb-2" style="font-size: 1.3rem;"></i>
      <div>ยังไม่มีโปรโมชันในขณะนี้</div>
    </div>
  {% endif %}
</div>

<style>
  .promo-card .card-img-top { object-fit: cover; }
  .promo-card .ratio { border-top-left-radius: .5rem; border-top-right-radius: .5rem; overflow: hidden; }
  .promo-card .clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .promo-wrapper .badge { font-weight: 600; }
</style>
