{% extends 'base/base.html' %}
{% block content %}
<div class="container py-4" style="padding-top: 80px !important;">
  <h4 class="fw-bold mb-3" style="color: #ff008b;">จัดการรูปภาพคูปอง</h4>

  <!-- Preview Carousel Section -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">ตัวอย่างการแสดงผล (Slide Preview)</h5>
      <p class="text-muted small mb-3">แสดงรูปภาพทีละ 2 รูป สไลด์อัตโนมัติ เพื่อนำไปแสดงในหน้าเพจอื่น</p>
      
      {% if image_pairs %}
      <div id="couponSlideCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-wrap="true">
        <div class="carousel-inner">
          {% for pair in image_pairs %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
              <div class="row g-3">
                <!-- รูปแรก -->
                <div class="col-md-6">
                  <div class="border rounded p-2 bg-light text-center {% if pair.first.partner %}cursor-pointer{% endif %}" style="min-height: 280px; display: flex; align-items: center; justify-content: center;" {% if pair.first.partner %}onclick="showPartnerPopup({{ pair.first.partner.id }})"{% endif %}>
                    <img src="{{ pair.first.image.url }}" alt="{{ pair.first.name }}" class="img-fluid rounded" style="max-height: 260px; width: 100%; object-fit: contain;">
                  </div>
                  {% if pair.first.partner %}
                  <p class="text-center small text-muted mt-1"><i class="fa fa-info-circle"></i> คลิกเพื่อดูคูปอง: {{ pair.first.partner.name }}</p>
                  {% endif %}
                </div>
                <!-- รูปที่สอง -->
                <div class="col-md-6">
                  {% if pair.second %}
                    <div class="border rounded p-2 bg-light text-center {% if pair.second.partner %}cursor-pointer{% endif %}" style="min-height: 280px; display: flex; align-items: center; justify-content: center;" {% if pair.second.partner %}onclick="showPartnerPopup({{ pair.second.partner.id }})"{% endif %}>
                      <img src="{{ pair.second.image.url }}" alt="{{ pair.second.name }}" class="img-fluid rounded" style="max-height: 260px; width: 100%; object-fit: contain;">
                    </div>
                    {% if pair.second.partner %}
                    <p class="text-center small text-muted mt-1"><i class="fa fa-info-circle"></i> คลิกเพื่อดูคูปอง: {{ pair.second.partner.name }}</p>
                    {% endif %}
                  {% else %}
                    <div class="border rounded p-2 bg-light d-flex align-items-center justify-content-center" style="min-height: 280px;">
                      <p class="text-muted mb-0">-</p>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
        
        <!-- Carousel Controls -->
        <button class="carousel-control-prev" type="button" data-bs-target="#couponSlideCarousel" data-bs-slide="prev" style="width: 8%;">
          <span class="carousel-control-prev-icon rounded-circle p-3" aria-hidden="true" style="background-color: #ff008b;"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#couponSlideCarousel" data-bs-slide="next" style="width: 8%;">
          <span class="carousel-control-next-icon rounded-circle p-3" aria-hidden="true" style="background-color: #ff008b;"></span>
          <span class="visually-hidden">Next</span>
        </button>
        
        <!-- Carousel Indicators -->
        <div class="carousel-indicators">
          {% for pair in image_pairs %}
            <button type="button" data-bs-target="#couponSlideCarousel" data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active" aria-current="true"{% endif %}></button>
          {% endfor %}
        </div>
      </div>
      {% else %}
      <div class="alert alert-info mb-0">
        <i class="fa fa-info-circle me-2"></i>ยังไม่มีรูปภาพในระบบ กรุณาเพิ่มรูปภาพก่อน
      </div>
      {% endif %}
    </div>
  </div>

  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">เพิ่มรูปภาพคูปอง</h5>
      
      <form method="post" enctype="multipart/form-data" class="row g-3">
        {% csrf_token %}
        <input type="hidden" name="action" value="add_image">
        
        <div class="col-md-4">
          <label class="form-label fw-semibold">ชื่อรูปภาพ</label>
          <input type="text" class="form-control" name="image_name" placeholder="ระบุชื่อรูปภาพ" required>
          <div class="form-text">เช่น คูปองส่วนลด 50%, โปรโมชั่นพิเศษ</div>
        </div>
        
        <div class="col-md-4">
          <label class="form-label fw-semibold">ลำดับการแสดงผล</label>
          <input type="number" class="form-control" name="sort_order" placeholder="10, 20, 30..." value="0" required>
          <div class="form-text">เรียงจากน้อยไปมาก เช่น 1, 2, 3</div>
        </div>
        
        <div class="col-md-4">
          <label class="form-label fw-semibold">เลือกรูปภาพ</label>
          <input type="file" class="form-control" name="image_file" accept="image/*" id="imageFileInput" required>
          <div class="form-text">รองรับ jpg, png, webp ขนาดไม่เกิน 5MB</div>
        </div>
        
        <div class="col-md-12">
          <label class="form-label fw-semibold">เชื่อมโยงกับพาร์ทเนอร์ (เมื่อคลิกรูปจะแสดงป๊อปอัพคูปอง)</label>
          <select class="form-select" name="partner_id">
            <option value="">-- ไม่เลือก (รูปจะคลิกไม่ได้) --</option>
            {% for partner in partners %}
            <option value="{{ partner.id }}">{{ partner.name }} - {{ partner.title }}</option>
            {% endfor %}
          </select>
          <div class="form-text">เลือกพาร์ทเนอร์เพื่อให้รูปภาพนี้เชื่อมโยงกับคูปองของพาร์ทเนอร์</div>
        </div>
        
        <div class="col-12">
          <div id="imagePreview" class="d-none">
            <label class="form-label fw-semibold">ตัวอย่างรูปภาพ</label>
            <div class="border rounded p-2 bg-light">
              <img id="previewImg" src="" alt="Preview" class="img-fluid" style="max-height: 300px;">
            </div>
          </div>
        </div>
        
        <div class="col-12 text-end">
          <button type="submit" class="btn" style="background-color: #ff008b; color: white; border: none;">
            <i class="fa fa-save me-2"></i>บันทึกรูปภาพ
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <h5 class="fw-bold mb-3">รายการรูปภาพคูปอง</h5>
      
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 80px;">ลำดับ</th>
              <th style="width: 150px;">รูปภาพ</th>
              <th>ชื่อรูปภาพ</th>
              <th style="width: 200px;">เชื่อมโยงพาร์ทเนอร์</th>
              <th style="width: 100px;">ลำดับแสดง</th>
              <th style="width: 150px;">วันที่เพิ่ม</th>
              <th style="width: 120px;" class="text-end">จัดการ</th>
            </tr>
          </thead>
          <tbody>
            {% for img in images %}
            <tr id="image_row_{{ img.id }}">
              <td>{{ forloop.counter }}</td>
              <td>
                {% if img.image %}
                <img src="{{ img.image.url }}" alt="{{ img.name }}" class="img-thumbnail" style="width: 100px; height: auto; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#imageModal" data-img-url="{{ img.image.url }}" data-img-name="{{ img.name }}">
                {% else %}
                <span class="text-muted">ไม่มีรูป</span>
                {% endif %}
              </td>
              <td>
                <span class="fw-semibold">{{ img.name }}</span>
              </td>
              <td>
                {% if img.partner %}
                <span class="badge bg-info text-dark">
                  <i class="fa fa-link me-1"></i>{{ img.partner.name }}
                </span>
                {% else %}
                <span class="text-muted small">ไม่ได้เชื่อมโยง</span>
                {% endif %}
              </td>
              <td>
                <span class="badge bg-secondary">{{ img.sort_order }}</span>
              </td>
              <td>
                <small class="text-muted">{{ img.created_at|date:"d/m/Y H:i" }}</small>
              </td>
              <td class="text-end">
                <div class="btn-group btn-group-sm">
                  <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editModal" data-id="{{ img.id }}" data-name="{{ img.name }}" data-sort-order="{{ img.sort_order }}" data-partner-id="{% if img.partner %}{{ img.partner.id }}{% endif %}" data-img-url="{{ img.image.url }}" title="แก้ไขข้อมูล">
                    <i class="fa fa-edit"></i> แก้ไข
                  </button>
                  <form method="post" class="d-inline" onsubmit="return confirm('ยืนยันการลบรูปภาพนี้?\n\n{{ img.name }}\n\nการดำเนินการนี้ไม่สามารถย้อนกลับได้');">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="image_id" value="{{ img.id }}">
                    <button type="submit" class="btn btn-outline-danger" title="ลบรูปภาพ">
                      <i class="fa fa-trash"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted py-4">ยังไม่มีรูปภาพ</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      {# Pagination Controls #}
      <div class="d-flex justify-content-between align-items-center mt-3" id="imagePaginationControls">
        <div>
          <span class="text-muted small">แสดง <span id="imageShowingStart">1</span>-<span id="imageShowingEnd">10</span> จาก <span id="imageTotal">0</span> รายการ</span>
        </div>
        <div>
          <button class="btn btn-sm btn-outline-secondary" id="imagePrevBtn" disabled>
            <i class="fa fa-chevron-left"></i> ก่อนหน้า
          </button>
          <span class="mx-2">หน้า <span id="imageCurrentPage">1</span> / <span id="imageTotalPages">1</span></span>
          <button class="btn btn-sm btn-outline-secondary" id="imageNextBtn">
            ถัดไป <i class="fa fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{# Modal สำหรับแก้ไขข้อมูลรูปภาพ #}
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
  <div class="modal-dialog modal-lg" style="margin-top: 80px;">
    <div class="modal-content">
      <form method="post" enctype="multipart/form-data" id="editImageForm">
        {% csrf_token %}
        <input type="hidden" name="action" value="edit">
        <input type="hidden" name="image_id" id="editImageId">
        
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="fa fa-edit me-2"></i>แก้ไขข้อมูลรูปภาพ</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        
        <div class="modal-body">
          <!-- ชื่อรูปภาพ -->
          <div class="mb-3">
            <label class="form-label fw-semibold">ชื่อรูปภาพ</label>
            <input type="text" class="form-control" name="image_name" id="editImageName" required>
          </div>
          
          <!-- ลำดับการแสดงผล -->
          <div class="mb-3">
            <label class="form-label fw-semibold">ลำดับการแสดงผล</label>
            <input type="number" class="form-control" name="sort_order" id="editSortOrder" required>
            <div class="form-text">เรียงจากน้อยไปมาก เช่น 1, 2, 3</div>
          </div>
          
          <!-- เชื่อมโยงพาร์ทเนอร์ -->
          <div class="mb-3">
            <label class="form-label fw-semibold">เชื่อมโยงกับพาร์ทเนอร์</label>
            <select class="form-select" name="partner_id" id="editPartnerId">
              <option value="">-- ไม่เลือก --</option>
              {% for partner in partners %}
              <option value="{{ partner.id }}">{{ partner.name }} - {{ partner.title }}</option>
              {% endfor %}
            </select>
            <div class="form-text">เมื่อคลิกรูปจะแสดงป๊อปอัพคูปองของพาร์ทเนอร์นี้</div>
          </div>
          
          <hr class="my-4">
          
          <!-- เปลี่ยนรูปภาพ (Optional) -->
          <div class="mb-3">
            <label class="form-label fw-semibold">
              <i class="fa fa-image me-2 text-success"></i>เปลี่ยนรูปภาพ (ถ้าต้องการ)
            </label>
            <input type="file" class="form-control" name="new_image_file" id="editNewImageFile" accept="image/*">
            <div class="form-text">หากต้องการเปลี่ยนรูป กรุณาเลือกไฟล์ใหม่ (jpg, png, webp ไม่เกิน 5MB)</div>
          </div>
          
          <!-- แสดง Preview รูปใหม่ -->
          <div id="editNewImagePreview" class="d-none">
            <label class="form-label fw-semibold text-success">
              <i class="fa fa-check-circle me-2"></i>ตัวอย่างรูปภาพใหม่
            </label>
            <div class="border rounded p-3 bg-light text-center">
              <img id="editNewPreviewImg" src="" alt="New Preview" class="img-fluid rounded shadow-sm" style="max-height: 200px;">
            </div>
            <div class="alert alert-warning mt-2 mb-0">
              <i class="fa fa-exclamation-triangle me-2"></i>
              <small>รูปภาพเก่าจะถูกลบและแทนที่ด้วยรูปใหม่</small>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fa fa-times me-2"></i>ยกเลิก
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fa fa-save me-2"></i>บันทึกการแก้ไข
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{# Modal สำหรับดูรูปภาพขนาดใหญ่ #}
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalTitle">ตัวอย่างรูปภาพ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="imageModalImg" src="" alt="Image" class="img-fluid">
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Auto-play carousel
  const carousel = document.getElementById('couponSlideCarousel');
  if (carousel) {
    const bsCarousel = new bootstrap.Carousel(carousel, {
      interval: 5000,  // เปลี่ยนทุก 5 วินาที
      wrap: true,      // วนซ้ำ
      touch: true      // รองรับการ swipe บนมือถือ
    });
  }
  
  // Image Preview
  const imageFileInput = document.getElementById('imageFileInput');
  const imagePreview = document.getElementById('imagePreview');
  const previewImg = document.getElementById('previewImg');
  
  imageFileInput.addEventListener('change', function() {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        imagePreview.classList.remove('d-none');
      };
      reader.readAsDataURL(file);
    }
  });
  
  // Edit Modal - รวมทั้งข้อมูลและรูปภาพ
  const editModal = document.getElementById('editModal');
  if (editModal) {
    editModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      const imageId = button.getAttribute('data-id');
      const imageName = button.getAttribute('data-name');
      const sortOrder = button.getAttribute('data-sort-order');
      const partnerId = button.getAttribute('data-partner-id');
      const imgUrl = button.getAttribute('data-img-url');
      
      document.getElementById('editImageId').value = imageId;
      document.getElementById('editImageName').value = imageName;
      document.getElementById('editSortOrder').value = sortOrder || 0;
      document.getElementById('editPartnerId').value = partnerId || '';
      
      // Reset preview
      document.getElementById('editNewImagePreview').classList.add('d-none');
      document.getElementById('editNewImageFile').value = '';
    });
  }
  
  // Preview รูปใหม่ในหน้าแก้ไข
  const editNewImageFile = document.getElementById('editNewImageFile');
  const editNewImagePreview = document.getElementById('editNewImagePreview');
  const editNewPreviewImg = document.getElementById('editNewPreviewImg');
  
  if (editNewImageFile) {
    editNewImageFile.addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        // ตรวจสอบขนาดไฟล์ (5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('ไฟล์มีขนาดใหญ่เกิน 5MB กรุณาเลือกไฟล์ใหม่');
          this.value = '';
          editNewImagePreview.classList.add('d-none');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          editNewPreviewImg.src = e.target.result;
          editNewImagePreview.classList.remove('d-none');
        };
        reader.readAsDataURL(file);
      } else {
        editNewImagePreview.classList.add('d-none');
      }
    });
  }
  
  // Image Modal
  const imageModal = document.getElementById('imageModal');
  if (imageModal) {
    imageModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      const imgUrl = button.getAttribute('data-img-url');
      const imgName = button.getAttribute('data-img-name');
      
      document.getElementById('imageModalImg').src = imgUrl;
      document.getElementById('imageModalTitle').textContent = imgName;
    });
  }
  
  // Pagination
  const itemsPerPage = 10;
  let currentPage = 1;
  const imageRows = document.querySelectorAll('tbody tr[id^="image_row_"]');
  const totalItems = imageRows.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  
  function showPage(page) {
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    
    imageRows.forEach((row, index) => {
      if (index >= start && index < end) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
    
    // Update pagination info
    document.getElementById('imageShowingStart').textContent = totalItems > 0 ? start + 1 : 0;
    document.getElementById('imageShowingEnd').textContent = Math.min(end, totalItems);
    document.getElementById('imageTotal').textContent = totalItems;
    document.getElementById('imageCurrentPage').textContent = page;
    document.getElementById('imageTotalPages').textContent = totalPages;
    
    // Update button states
    document.getElementById('imagePrevBtn').disabled = page === 1;
    document.getElementById('imageNextBtn').disabled = page === totalPages || totalPages === 0;
  }
  
  // Hide pagination if 10 or fewer items
  if (totalItems <= itemsPerPage) {
    document.getElementById('imagePaginationControls').style.display = 'none';
  }
  
  // Event listeners
  document.getElementById('imagePrevBtn').addEventListener('click', function() {
    if (currentPage > 1) {
      currentPage--;
      showPage(currentPage);
    }
  });
  
  document.getElementById('imageNextBtn').addEventListener('click', function() {
    if (currentPage < totalPages) {
      currentPage++;
      showPage(currentPage);
    }
  });
  
  // Initial page load
  showPage(currentPage);
});

// ฟังก์ชันเปิด popup คูปองพาร์ทเนอร์
function showPartnerPopup(partnerId) {
  if (!partnerId) return;
  
  // ใช้ URL API เดียวกับที่หน้า redeem.html ใช้
  fetch(`/account/partner/${partnerId}/coupons/`)
    .then(response => response.json())
    .then(data => {
      if (data.coupons && data.coupons.length > 0) {
        // หาคูปองที่แลกได้
        const availableCoupon = data.coupons.find(c => c.active && c.enough_points);
        const displayCoupon = availableCoupon || data.coupons[0];
        
        // สร้าง modal แสดงข้อมูล
        showCouponModal(data, displayCoupon);
      } else {
        alert('ไม่พบคูปองสำหรับพาร์ทเนอร์นี้');
      }
    })
    .catch(error => {
      console.error('Error loading partner coupons:', error);
      alert('ไม่สามารถโหลดข้อมูลได้');
    });
}

function showCouponModal(data, displayCoupon) {
  // สร้าง modal element ถ้ายังไม่มี
  let modal = document.getElementById('partnerCouponModal');
  if (!modal) {
    const modalHTML = `
      <div class="modal fade" id="partnerCouponModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <h5 class="modal-title fw-bold text-white" id="modalPartnerName"></h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
              <!-- รูปคูปอง QR Code -->
              <div class="text-center mb-4" id="modalCouponImageContainer">
                <img id="modalCouponImage" src="" alt="Coupon QR" class="img-fluid rounded-3 shadow-sm" style="max-height: 200px; max-width: 200px; display: none; margin: 0 auto;">
              </div>
              
              <!-- รายละเอียดคูปอง -->
              <div class="card mb-3 border-0 bg-light">
                <div class="card-body">
                  <h6 class="fw-semibold mb-3" style="color: #ff008b;"><i class="fa fa-info-circle me-2"></i>รายละเอียดคูปอง</h6>
                  <div class="row g-2">
                    <div class="col-12">
                      <p class="mb-2"><strong>ชื่อคูปอง:</strong> <span id="modalCouponName" style="color: #ff008b;"></span></p>
                    </div>
                    <div class="col-6">
                      <p class="mb-2"><strong>รหัส:</strong> <span id="modalCouponCode" class="badge" style="background-color: #ff008b; color: white;"></span></p>
                    </div>
                    <div class="col-6">
                      <p class="mb-2"><strong>แต้มที่ใช้:</strong> <span id="modalCouponPoints" class="text-danger fw-bold"></span> คะแนน</p>
                    </div>
                    <div class="col-12">
                      <p class="mb-2"><strong>สาขาที่ใช้ได้:</strong> <span id="modalCouponBranches" class="text-muted"></span></p>
                    </div>
                    <div class="col-12">
                      <p class="mb-0"><strong>หมายเหตุ:</strong> <span id="modalCouponNote" class="text-secondary"></span></p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- สถานะคูปอง -->
              <div class="card mb-3 border-0" style="background-color: #f0f9ff;">
                <div class="card-body">
                  <h6 class="fw-semibold mb-3" style="color: #ff008b;"><i class="fa fa-chart-bar me-2"></i>สถานะคูปอง</h6>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">คูปองที่เหลือ</span>
                    <span id="modalCouponCountText" class="fw-bold" style="color: #ff008b;">0 คูปอง</span>
                  </div>
                  <div class="progress" style="height: 25px;">
                    <div class="progress-bar bg-success" id="modalCouponProgress" style="width: 0%;" role="progressbar">
                      <span class="fw-semibold" id="modalCouponProgressText">0%</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- ปุ่มปิด -->
              <div class="text-center">
                <button type="button" class="btn btn-outline-secondary w-100 fw-semibold py-2 rounded-3" data-bs-dismiss="modal">
                  ปิด
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    modal = document.getElementById('partnerCouponModal');
  }
  
  // อัพเดทข้อมูลใน modal
  document.getElementById('modalPartnerName').textContent = data.partner_name || 'พาร์ทเนอร์';
  document.getElementById('modalCouponName').textContent = displayCoupon.name || '-';
  document.getElementById('modalCouponCode').textContent = displayCoupon.code || '-';
  document.getElementById('modalCouponPoints').textContent = displayCoupon.required_points || '0';
  document.getElementById('modalCouponNote').textContent = displayCoupon.note || 'ไม่มีหมายเหตุ';
  document.getElementById('modalCouponBranches').textContent = displayCoupon.available_branches || 'ใช้ได้ทุกสาขา';
  
  // แสดงรูป QR Code ถ้ามี
  const imgElement = document.getElementById('modalCouponImage');
  if (displayCoupon.image_code_url) {
    imgElement.src = displayCoupon.image_code_url;
    imgElement.style.display = 'block';
  } else {
    imgElement.style.display = 'none';
  }
  
  // คำนวณเปอร์เซ็นต์คูปองที่เหลือ
  const activeCount = data.coupons.filter(c => c.active).length;
  const totalCount = data.coupons.length;
  const percent = totalCount > 0 ? Math.round((activeCount / totalCount) * 100) : 0;
  
  document.getElementById('modalCouponProgress').style.width = percent + '%';
  document.getElementById('modalCouponProgressText').textContent = percent + '%';
  document.getElementById('modalCouponCountText').textContent = activeCount + ' จาก ' + totalCount + ' คูปอง';
  
  // แสดง modal
  const bsModal = new bootstrap.Modal(modal);
  bsModal.show();
}
</script>

<style>
.cursor-pointer {
  cursor: pointer !important;
}
.cursor-pointer:hover {
  opacity: 0.8;
  transform: scale(1.02);
  transition: all 0.2s;
}
</style>

{% endblock %}
