{% extends 'base/base.html' %}
{% block content %}
<div class="container py-4">
  <h4 class="fw-bold text-success mb-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á (Staff)</h4>

  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h5>
      <form method="post" class="row g-3" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="action" value="create">
        <div class="col-md-4">
          <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</label>
          <input class="form-control" name="name" required>
        </div>
          <div class="col-md-4">
          <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</label>
          <input class="form-control" name="code" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ</label>
          <input class="form-control" type="number" name="required_points" min="0" value="0" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label>
          <input class="form-control" type="datetime-local" name="expires_at" required>
        </div>
        <div class="col-md-8">
          <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
          <textarea class="form-control" rows="2" name="description"></textarea>
        </div>
      
        <div class="col-md-4">
          <label class="form-label">‡∏£‡∏π‡∏õ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</label>
          <input class="form-control" type="file" name="image" accept="image/*">
          <div class="form-text">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö jpg, png, webp ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2MB</div>
        </div>

        <div class="col-md-4">
          <label class="form-label">‡∏£‡∏π‡∏õ QR Code</label>
          <input class="form-control" type="file" name="image_qr" accept="image/*">
          <div class="form-text">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö jpg, png, webp ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2MB</div>
        </div>

        <div class="col-12 text-end">
          <button class="btn btn-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <h5 class="fw-bold mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h5>
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              {% comment %} <th style="width:120px;">‡∏£‡∏π‡∏õ</th> {% endcomment %}
              <th>‡∏ä‡∏∑‡πà‡∏≠</th>
              <th>‡∏£‡∏´‡∏±‡∏™</th>
              <th>‡πÅ‡∏ï‡πâ‡∏°</th>
              <th>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th class="text-end">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody>
            {% for c in coupons %}
            <tr>
              {% comment %} <td>
                {% if c.image and c.image_code  %}
                    <img src="{{ c.image.url }}" alt="coupon" class="img-thumbnail" style="width:100px;height:auto;">
                    <img src="{{ c.image_code.url }}" alt="coupon" class="img-thumbnail" style="width:100px;height:auto;">
                {% elif c.image %}
                  Ô∏è  <img src="{{ c.image.url }}" alt="coupon" class="img-thumbnail" style="width:100px;height:auto;">
                {% elif c.image_code %}  
                    <img src="{{ c.image_code.url }}" alt="coupon" class="img-thumbnail" style="width:100px;height:auto;">
                {% else %}
                  <span class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</span>
                {% endif %}
              </td> {% endcomment %}
               <td>{{ c.name }}</td>
              <td>{{ c.code }}</td>
              <td>
                {% if c.required_points is not None %}
                  {{ c.required_points }}
                {% else %}
                  {% if not c.active %}
                    <span class="badge bg-secondary">‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß</span>
                  {% elif c.max_uses and c.use_count >= c.max_uses %}
                    <span class="badge bg-danger">‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span>
                  {% elif c.ends_at and c.ends_at|date:"U" < now|date:"U" %}
                    <span class="badge bg-dark">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>
                  {% else %}
                    <span class="badge bg-success">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</span>
                  {% endif %}
                </td>
                {% endif %}
              </td>
              <td>{{ c.expires_at }}</td>
              <td>
                {% if c.is_active %}
                  <span class="badge bg-success">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                {% else %}
                  <span class="badge bg-secondary">‡∏õ‡∏¥‡∏î</span>
                {% endif %}
              </td>
              <td class="text-end">
                <div class="d-flex gap-2 justify-content-end flex-wrap">
                  <form method="post" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="toggle">
                    <input type="hidden" name="coupon_id" value="{{ c.id }}">
                    <button class="btn btn-outline-primary btn-sm">‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
                  </form>

                  {% comment %} <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö --> {% endcomment %}
              <form method="POST" style="display:inline;" onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="coupon_id" value="{{ c.id }}">
                <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è ‡∏•‡∏ö</button>
              </form>
                <button type="button"
                      class="btn btn-sm btn-warning"
                      data-bs-toggle="modal"
                      data-bs-target="#editCouponModal"
                      data-id="{{ c.id }}"
                      data-name="{{ c.name }}"
                      data-code="{{ c.code }}"
                      data-required_points="{{ c.required_points }}"
                      data-expires_at="{{ c.expires_at|date:'Y-m-d\\TH:i' }}"
                      data-description="{{ c.note }}"
                      {% if c.image %}
                      data-image="{{ c.image.url }}"
                      {% endif %}
                      {% if c.image_code %}
                      data-image_code="{{ c.image_code.url }}" 
                      {% endif %}> 
                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
              </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="6" class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="editCouponModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <form method="post" enctype="multipart/form-data" class="modal-content">
      {% csrf_token %}
      <input type="hidden" name="action" value="update">
      <input type="hidden" name="coupon_id" id="edit_id">
      <div class="modal-header">
        <h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body row g-3">
        <div class="col-12">
          <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</label>
          <input class="form-control" name="name" id="edit_name" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</label>
          <input class="form-control" name="code" id="edit_code" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ</label>
          <input class="form-control" type="number" name="required_points" id="edit_required_points" min="0">
        </div>
        <div class="col-md-6">
          <label class="form-label">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label>
          <input class="form-control" type="datetime-local" name="expires_at" id="edit_expires_at">
        </div>
        <div class="col-12">
          <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
          <textarea class="form-control" rows="2" name="description" id="edit_description"></textarea>
        </div>
      <div class="col-6">
        <label class="form-label d-block">‡∏£‡∏π‡∏õ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</label>
        <div class="d-flex align-items-center gap-3">
          <img id="preview_image" src="" alt="coupon" class="img-thumbnail"
              style="width:120px;height:auto;display:none;">
          <div class="d-flex flex-column gap-2">
            <input class="form-control" type="file" name="image" id="file_image" accept="image/*">
            <div class="d-flex gap-2">
              <button type="button" id="mark_remove_image" class="btn btn-outline-danger btn-sm">‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ</button>
              <button type="button" id="undo_remove_image" class="btn btn-outline-secondary btn-sm" style="display:none;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö</button>
            </div>
            <input type="hidden" name="remove_image" id="remove_image" value="0">
          </div>
        </div>
      </div>
      <div class="col-6">
        <label class="form-label d-block">‡∏£‡∏π‡∏õ QR</label>
        <div class="d-flex align-items-center gap-3">
          <img id="preview_image_code" src="" alt="coupon-qr" class="img-thumbnail"
              style="width:120px;height:auto;display:none;">
          <div class="d-flex flex-column gap-2">
            <input class="form-control" type="file" name="image_code" id="file_image_code" accept="image/*">
            <div class="d-flex gap-2">
              <button type="button" id="mark_remove_image_code" class="btn btn-outline-danger btn-sm">‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ</button>
              <button type="button" id="undo_remove_image_code" class="btn btn-outline-secondary btn-sm" style="display:none;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö</button>
            </div>
            <input type="hidden" name="remove_image_code" id="remove_image_code" value="0">
          </div>
        </div>
      </div>
      </div>
              <div class="modal-footer">
                <button class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              </div>
            </form>
          </div>
        </div>
<script>
(function() {
  const modal = document.getElementById('editCouponModal');

  function applyStagedState(kind, hasImage, marked) {
    const preview = modal.querySelector('#preview_' + kind);
    const file    = modal.querySelector('#file_' + kind);
    const markBtn = modal.querySelector('#mark_remove_' + kind);
    const undoBtn = modal.querySelector('#undo_remove_' + kind);
    const hidden  = modal.querySelector('#remove_' + kind);

    hidden.value = marked ? '1' : '0';

   
    if (hasImage) {
      preview.style.display = 'inline-block';
      if (marked) {
        preview.style.opacity = '0.35';
        preview.style.filter = 'grayscale(100%)';
        preview.style.textDecoration = 'line-through'; 
      } else {
        preview.style.opacity = '1';
        preview.style.filter = 'none';
        preview.style.textDecoration = 'none';
      }
    } else {
      preview.style.display = 'none';
    }

    markBtn.style.display = (hasImage && !marked) ? 'inline-block' : 'none';
    undoBtn.style.display = (hasImage && marked) ? 'inline-block' : 'none';

  
    file.onchange = () => {
      if (file.files && file.files.length > 0) {
        applyStagedState(kind, true, false); 
      }
    };
  }

  modal.addEventListener('show.bs.modal', function (event) {
    const btn   = event.relatedTarget;
    const id   = btn.getAttribute('data-id');
    const name = btn.getAttribute('data-name') || '';
    const code = btn.getAttribute('data-code') || '';
    const pts  = btn.getAttribute('data-required_points') || '';
    const exp  = btn.getAttribute('data-expires_at') || '';
    const desc = btn.getAttribute('data-description') || '';

    this.querySelector('#edit_id').value = id;
    this.querySelector('#edit_name').value = name;
    this.querySelector('#edit_code').value = code;
    this.querySelector('#edit_required_points').value = pts;
    this.querySelector('#edit_expires_at').value = exp;
    this.querySelector('#edit_description').value = desc;
    const img   = btn.getAttribute('data-image') || '';
    const imgQr = btn.getAttribute('data-image_code') || '';
    const prevImg   = modal.querySelector('#preview_image');
    const prevImgQr = modal.querySelector('#preview_image_code');
    if (img) { prevImg.src = img; }
    if (imgQr) { prevImgQr.src = imgQr; }

    applyStagedState('image', !!img, false);
    applyStagedState('image_code', !!imgQr, false);
  });

  modal.addEventListener('click', function (e) {
    if (e.target.id === 'mark_remove_image')    applyStagedState('image', true,  true);
    if (e.target.id === 'undo_remove_image')    applyStagedState('image', true,  false);
    if (e.target.id === 'mark_remove_image_code') applyStagedState('image_code', true,  true);
    if (e.target.id === 'undo_remove_image_code') applyStagedState('image_code', true,  false);
  });
})();

document.addEventListener("DOMContentLoaded", function () {
    const fileInputQR = document.getElementById("file_image_code");
    const previewImageQR = document.getElementById("preview_image_code");

    fileInputQR.addEventListener("change", function () {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                previewImageQR.src = e.target.result;
                previewImageQR.style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    });
});
</script>

{% endblock %}
