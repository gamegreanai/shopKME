{% extends 'base/base.html' %}
{% block title %}‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πâ‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ{% endblock %}
{% block content %}

<div class="container">
  <h4 class="fw-bold text-success mb-3 mt-4">
    <i class="fa fa-coins me-2"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πâ‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
  </h4>

  <!--  Search bar -->
  <form method="get" class="d-flex mb-3">
    <input type="text" name="q" value="{{ query }}" class="form-control me-2" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£...">
    <button type="submit" class="btn btn-success"><i class="fa fa-search me-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
  </form>

  <!--  ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
  <form method="post">
    {% csrf_token %}
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <table class="table table-hover table-bordered align-middle text-center">
          <thead class="table-success">
            <tr>
              <th><input type="checkbox" id="select-all"></th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
              <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
              <th>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th>
              <th>‡πÅ‡∏ï‡πâ‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th>
              <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th>
              <th>‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</th>
            </tr>
          </thead>
          <tbody>
            {% for p in profiles %}
            <tr>
              <td><input type="checkbox" name="selected_users" value="{{ p.user.id }}"></td>
              <td>{{ p.user.first_name|default:"-" }} {{ p.user.last_name|default:"-" }}</td>
              <td>{{ p.user.phone }}</td>
              <td>
                {% if p.user.is_superuser %}
                  <span class="badge bg-danger">Admin</span>
                {% elif p.user.is_staff %}
                  <span class="badge bg-info">Staff</span>
                {% else %}
                  <span class="badge bg-secondary">User</span>
                {% endif %}
              </td>
              <td><span class="badge bg-success fs-6">{{ p.points }}</span></td>
              <td>
                {% if p.user.id != request.user.id %}
                <div class="dropdown">
                  <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fa fa-user-cog"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <form method="post" action="{% url 'account:toggle_user_role' p.user.id %}" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="make_admin">
                        <button type="submit" class="dropdown-item" onclick="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Admin?');">
                          ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Admin
                        </button>
                      </form>
                    </li>
                    <li>
                      <form method="post" action="{% url 'account:toggle_user_role' p.user.id %}" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="make_staff">
                        <button type="submit" class="dropdown-item" onclick="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Staff?');">
                          ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Staff
                        </button>
                      </form>
                    </li>
                    <li>
                      <form method="post" action="{% url 'account:toggle_user_role' p.user.id %}" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="remove_staff">
                        <button type="submit" class="dropdown-item" onclick="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô User ‡∏õ‡∏Å‡∏ï‡∏¥?');">
                          ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô User ‡∏õ‡∏Å‡∏ï‡∏¥
                        </button>
                      </form>
                    </li>
                  </ul>
                </div>
                {% else %}
                  <span class="badge bg-warning">‡∏ï‡∏±‡∏ß‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á</span>
                {% endif %}
              </td>
              <td>
                <a href="{% url 'account:edit_user' p.user.id %}" class="btn btn-warning btn-sm">
                  <i class="fa fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </a>
              </td>
              <td>
                <a href="{% url 'account:delete_user' p.user.id %}" class="btn btn-danger btn-sm"
                  onclick="return confirm('‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ?');">
                  <i class="fa fa-trash"></i> ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                </a>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="8" class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</td></tr>
            {% endfor %}
          </tbody>
        </table>

        <!--  Pagination: ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
        {% if profiles.has_other_pages %}
        <div class="d-flex justify-content-center mt-3">
          <nav>
            <ul class="pagination">
              {% if profiles.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?user_page={{ profiles.previous_page_number }}{% if query %}&q={{ query }}{% endif %}">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</a>
              </li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</span></li>
              {% endif %}

              <li class="page-item disabled">
                <span class="page-link">‡∏´‡∏ô‡πâ‡∏≤ {{ profiles.number }} / {{ profiles.paginator.num_pages }}</span>
              </li>

              {% if profiles.has_next %}
              <li class="page-item">
                <a class="page-link" href="?user_page={{ profiles.next_page_number }}{% if query %}&q={{ query }}{% endif %}">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</a>
              </li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span></li>
              {% endif %}
            </ul>
          </nav>
        </div>
        {% endif %}

        <div class="d-flex mt-3">
          <input type="text" name="points_change" class="form-control me-2" placeholder="+500 ‡∏´‡∏£‡∏∑‡∏≠ -200"
            style="max-width: 150px;">
          <button type="submit" class="btn btn-success"><i class="fa fa-check"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ï‡πâ‡∏°</button>
        </div>
      </div>
    </div>
  </form>

  <!--  ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
  <div class="card shadow-sm">
    <div class="card-header bg-secondary text-white">
      <i class="fa fa-history me-2"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    </div>
    <div class="card-body">
      <table class="table table-striped text-center align-middle">
        <thead>
          <tr>
            <th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
            <th>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</th>
            <th>‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
            <th>‡πÅ‡∏ï‡πâ‡∏°</th>
            <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
          </tr>
        </thead>
        <tbody>
          {% for h in history %}
          <tr>
            <td>{{ h.user.phone }}</td>
            <td>{{ h.staff.username|default:"-" }}</td>
            <td>
              {% if h.action == 'add' %}
              <span class="text-success fw-bold">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</span>
              {% else %}
              <span class="text-danger fw-bold">- ‡∏•‡∏ö</span>
              {% endif %}
            </td>
            <td>{{ h.points }}</td>
            <td>{{ h.created_at|date:"d/m/Y H:i" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°</td></tr>
          {% endfor %}
        </tbody>
      </table>

      <!--  Pagination: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏° -->
      {% if history.has_other_pages %}
      <div class="d-flex justify-content-center mt-3">
        <nav>
          <ul class="pagination">
            {% if history.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?history_page={{ history.previous_page_number }}">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</span></li>
            {% endif %}

            <li class="page-item disabled">
              <span class="page-link">‡∏´‡∏ô‡πâ‡∏≤ {{ history.number }} / {{ history.paginator.num_pages }}</span>
            </li>

            {% if history.has_next %}
            <li class="page-item">
              <a class="page-link" href="?history_page={{ history.next_page_number }}">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!--  JavaScript -->
<script>
  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  document.getElementById("select-all").addEventListener("change", function() {
    document.querySelectorAll("input[name='selected_users']").forEach(cb => cb.checked = this.checked);
  });
</script>

<!--  ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏±‡∏ö Navbar -->
<style>
  .container {
    margin-top: clamp(110px, 10vw, 130px);
  }

  {% comment %} /* üì± iPad */ {% endcomment %}
  @media (max-width: 991px) {
    .container {
      margin-top: 115px;
      padding: 1rem;
    }
  }

  {% comment %} /*  ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */ {% endcomment %}
  @media (max-width: 768px) {
    .container {
      margin-top: 100px !important;
      padding: 0.8rem !important;
    }
    h4 {
      font-size: 1.2rem;
      text-align: center;
    }
    table {
      font-size: 0.9rem;
    }
    .btn {
      font-size: 0.9rem;
      padding: 0.4rem 0.8rem;
    }
  }
</style>

{% endblock %}
